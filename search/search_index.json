{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"proxmox/","title":"Proxmox Deployment Playbook","text":""},{"location":"proxmox/#overview","title":"Overview","text":"<p>The <code>proxmox.yaml</code> playbook automates the deployment and configuration of Proxmox hosts and VM templates. It handles baseline server configuration and creates reusable VM templates for both Ubuntu and Debian distributions.</p>"},{"location":"proxmox/#goal","title":"Goal","text":"<p>The playbook achieves two primary objectives:</p> <ol> <li>Baseline Configuration: Hardens and configures Proxmox hosts with essential tools and security settings</li> <li>Template Creation: Builds cloud-init enabled VM templates that can be quickly cloned for new virtual machines</li> </ol>"},{"location":"proxmox/#playbook-structure","title":"Playbook Structure","text":""},{"location":"proxmox/#play-target","title":"Play Target","text":"<ul> <li>Hosts: <code>proxmox_hosts</code> (defined in your Ansible inventory)</li> </ul>"},{"location":"proxmox/#tasks","title":"Tasks","text":""},{"location":"proxmox/#1-import-variables","title":"1. Import Variables","text":"<p>Loads all variables from the <code>../vars</code> directory, including secrets from the Ansible vault.</p>"},{"location":"proxmox/#2-baseline-configuration","title":"2. Baseline Configuration","text":"<p>Runs the <code>server_baseline</code> role to configure Proxmox hosts with: - User creation (vcaldas) - SSH hardening and key-based authentication - Timezone configuration (Europe/Amsterdam) - System packages (tmux, ncdu) - Tailscale VPN integration</p>"},{"location":"proxmox/#3-vm-template-deployment","title":"3. VM Template Deployment","text":"<p>Uses the <code>proxmox_template_vm</code> role to create cloud-init enabled templates for: - Ubuntu 24.04 (ubuntu-2604-template) - Debian (debian-template)</p>"},{"location":"proxmox/#configuration-variables","title":"Configuration Variables","text":""},{"location":"proxmox/#required-proxmox-credentials","title":"Required Proxmox Credentials","text":"<p>These must be provided from the Ansible vault:</p> <pre><code>proxmox_template_vm_proxmox_username     # Proxmox API username\nproxmox_template_vm_proxmox_api_token_id # Proxmox API token ID\nproxmox_template_vm_proxmox_api_token_secret # Proxmox API token secret\n</code></pre>"},{"location":"proxmox/#ubuntu-template-options","title":"Ubuntu Template Options","text":"<pre><code>proxmox_template_vm_ubuntu_storage       # Storage pool (local-lvm)\nproxmox_template_vm_ubuntu_name          # Template name\nproxmox_template_vm_ubuntu_memory        # RAM in MB (4096)\nproxmox_template_vm_ubuntu_cores         # CPU cores (1)\nproxmox_template_vm_ubuntu_ciuser        # Cloud-init user (vcaldas)\nproxmox_template_vm_ubuntu_cipassword    # Cloud-init password (from vault)\nproxmox_template_vm_ubuntu_sshkeys       # SSH public key (auto-loaded from user home)\nproxmox_template_vm_ubuntu_vlan          # Optional VLAN ID\n</code></pre>"},{"location":"proxmox/#debian-template-options","title":"Debian Template Options","text":"<p>Same structure as Ubuntu with <code>debian</code> prefix instead of <code>ubuntu</code>.</p>"},{"location":"proxmox/#advanced-settings","title":"Advanced Settings","text":"<pre><code>proxmox_template_vm_slow_storage: true   # Enable if using slow storage (avoids file locks)\n</code></pre>"},{"location":"proxmox/#tailscale-integration","title":"Tailscale Integration","text":"<p>Both Proxmox hosts and VM templates are configured with Tailscale VPN using: - OAuth client credentials from vault - Auto-tagged devices (\"servers\") - Ephemeral key disabled - Pre-authorized mode enabled</p> <p>This allows direct connectivity to all Proxmox infrastructure via the Tailscale mesh network.</p>"},{"location":"proxmox/#ssh-key-management","title":"SSH Key Management","text":"<p>The playbook automatically: 1. Uses your local SSH public key (<code>~/.ssh/id_ed25519.pub</code>) for cloud-init 2. Disables password authentication on all hosts 3. Configures key-based authentication for users</p>"},{"location":"proxmox/#prerequisites","title":"Prerequisites","text":"<ol> <li>Proxmox host(s) in your Ansible inventory under <code>proxmox_hosts</code> group</li> <li>Ansible vault with:</li> <li>Proxmox API credentials</li> <li>Tailscale OAuth client secret</li> <li>Cloud-init password</li> <li>SSH access to Proxmox hosts</li> <li>SSH public key available at <code>~/.ssh/id_ed25519.pub</code></li> </ol>"},{"location":"proxmox/#running-the-playbook","title":"Running the Playbook","text":"<p>From the <code>ansible/</code> directory:</p> <pre><code>./run.sh\n</code></pre> <p>Or manually:</p> <pre><code>ansible-playbook -v playbooks/proxmox.yaml \\\n  --inventory hosts.yml \\\n  --vault-password-file ~/.vault-pw\n</code></pre>"},{"location":"proxmox/#output","title":"Output","text":"<p>The playbook creates: - Hardened Proxmox host with baseline security - Ubuntu 24.04 cloud-init template (ready to clone as VMs) - Debian cloud-init template (ready to clone as VMs) - Tailscale integration on all hosts and templates</p>"},{"location":"proxmox/#related-documentation","title":"Related Documentation","text":"<ul> <li>Server Baseline Role - Host hardening and configuration</li> <li>Proxmox Template VM Role - VM template creation details</li> </ul>"},{"location":"setup_sudoers/","title":"Sudoers Setup","text":"<p>For both the pi and proxmox host groups, it\u2019ll do the following:</p> <p>Make sure sudo is present on the machines. Enable passwordless sudo for any user in the sudo group. The lineinfile also has a handy validation function which will validate the changes on a temporary file before overwriting. This way the sudoers file doesn\u2019t accidentally get borked. For every item in the users var, create a user with item.name. The contents for item.password end up exact in /etc/shadow, so it must be hashed and salted beforehand. To do this, it can be generated with openssl passwd -6 -salt  . For every item in the users var, add authorized keys from GitHub based on the item.github key. This is similar to previous steps with ssh-import-id, but this is adding the public keys for the newly created user. <pre><code>generate salt:\n\n```shell\nopenssl passwd -6 -salt &lt;salt&gt; &lt;password&gt;.\n</code></pre>"},{"location":"vlans/","title":"Home Network VLANS","text":"VLAN NAME SUBNET PURPOSE 1 MANAGEMENT 10.1.1.0/16 Network devices management. Router, AP, etc 10 HOME 10.10.0.0/16 General home devices. 20 SERVERS 10.20.0.0/16 Virtual machines and container workloads. 30 IOT 10.30.0.0/16 Home servers and NAS devices. 40 GUEST 10.40.0.0/16 Guest devices and networks. 70 DMZ 10.70.0.0/16 Public-facing services and applications. 60 KIDS 10.60.0.0/16 Children's devices with restricted access."},{"location":"vlans/#vlan-configuration","title":"VLAN Configuration","text":"<p>Management Network</p> <ul> <li>VLAN ID: 1 Devices:     Unifi Router: 10.1.1.2     Unifi AP: 10.1.10.1     Unifi AP2: 10.1.10.2</li> </ul>"},{"location":"roles/proxmox_template_vm/","title":"Proxmox Template VM Role","text":"<p>This role deploys template VMs to your Proxmox host/cluster with cloud-init support. These templates can be cloned to create VMs that are pre-configured with your user, password, and SSH keys. You can even pre-configure network settings, allowing you to clone the template and SSH into the VM as soon as it boots.</p> <p>A template VM will be created on each host in the group. A randomized 4-5 digit VMID will be generated based on the host's machine ID.</p>"},{"location":"roles/proxmox_template_vm/#requirements","title":"Requirements","text":""},{"location":"roles/proxmox_template_vm/#proxmox-api-token","title":"Proxmox API Token","text":"<p>You need a Proxmox API token to authenticate with your Proxmox node/cluster for VM creation.</p> <p>To create one: 1. Go to Datacenter \u2192 Permissions \u2192 API Tokens in the Proxmox web UI 2. Create a new token with appropriate permissions for VM management</p>"},{"location":"roles/proxmox_template_vm/#role-variables","title":"Role Variables","text":""},{"location":"roles/proxmox_template_vm/#required-variables","title":"Required Variables","text":"<p>Not providing any of the following variables will cause the task to fail.</p> <pre><code>proxmox_template_vm_proxmox_username: &lt;username&gt;              # Proxmox username (e.g., root)\nproxmox_template_vm_proxmox_api_token_id: &lt;token-id&gt;          # API token ID\nproxmox_template_vm_proxmox_api_token_secret: &lt;token-secret&gt;  # API token secret\nproxmox_template_vm_distros: []                                # List of distros (ubuntu, debian, fedora)\n</code></pre>"},{"location":"roles/proxmox_template_vm/#example-required-variables","title":"Example - Required Variables","text":"<pre><code>proxmox_template_vm_proxmox_username: \"{{ proxmox_username }}\"            # From vault\nproxmox_template_vm_proxmox_api_token_id: \"{{ proxmox_api_token_id }}\"    # From vault\nproxmox_template_vm_proxmox_api_token_secret: \"{{ proxmox_api_token_secret }}\"  # From vault\n\nproxmox_template_vm_distros:\n  - ubuntu\n  - debian\n</code></pre>"},{"location":"roles/proxmox_template_vm/#template-configuration-variables","title":"Template Configuration Variables","text":"<p>Customize VM templates with these variables (each has a default):</p> <pre><code>proxmox_template_vm_ubuntu_name: ubuntu-2604-template\nproxmox_template_vm_ubuntu_memory: 4096              # MB\nproxmox_template_vm_ubuntu_cores: 1\nproxmox_template_vm_ubuntu_storage: local-lvm\n\nproxmox_template_vm_debian_name: debian-template\nproxmox_template_vm_debian_memory: 4096              # MB\nproxmox_template_vm_debian_cores: 1\nproxmox_template_vm_debian_storage: local-lvm\n</code></pre>"},{"location":"roles/proxmox_template_vm/#cloud-init-configuration","title":"Cloud-Init Configuration","text":"<p>Optional cloud-init settings (omitted if not provided):</p> <pre><code>proxmox_template_vm_ubuntu_ciuser: vcaldas           # Cloud-init username\nproxmox_template_vm_ubuntu_cipassword: &lt;password&gt;    # Cloud-init password\nproxmox_template_vm_ubuntu_sshkeys: &lt;public-key&gt;     # SSH key for cloud-init\nproxmox_template_vm_ubuntu_vlan: 50                  # Optional VLAN tag\n</code></pre>"},{"location":"roles/proxmox_template_vm/#slow-storage-configuration","title":"Slow Storage Configuration","text":"<p>If your storage is prone to file locking, enable slow storage mode:</p> <pre><code>proxmox_template_vm_slow_storage: true   # Default: false\n</code></pre> <p>If a task fails due to file lock errors, simply re-run the playbook. See Proxmox discussion for details.</p>"},{"location":"roles/proxmox_template_vm/#dependencies","title":"Dependencies","text":""},{"location":"roles/proxmox_template_vm/#communitygeneral-collection","title":"community.general Collection","text":"<p>This role requires the community.general collection for: - community.general.proxmox_kvm - community.general.proxmox_disk</p>"},{"location":"roles/proxmox_template_vm/#example-playbook","title":"Example Playbook","text":"<pre><code>- name: Deploy VM templates\n  hosts: proxmox_hosts\n\n  tasks:\n    - name: Deploy templates\n      ansible.builtin.include_role:\n        name: proxmox_template_vm\n      vars:\n        proxmox_template_vm_proxmox_username: \"{{ proxmox_username }}\"\n        proxmox_template_vm_proxmox_api_token_id: \"{{ proxmox_api_token_id }}\"\n        proxmox_template_vm_proxmox_api_token_secret: \"{{ proxmox_api_token_secret }}\"\n\n        proxmox_template_vm_distros:\n          - ubuntu\n          - debian\n\n        proxmox_template_vm_ubuntu_name: ubuntu-2604-template\n        proxmox_template_vm_ubuntu_memory: 4096\n        proxmox_template_vm_ubuntu_cores: 1\n        proxmox_template_vm_ubuntu_ciuser: vcaldas\n        proxmox_template_vm_ubuntu_cipassword: \"{{ cipassword }}\"\n        proxmox_template_vm_ubuntu_sshkeys: \"{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_ed25519.pub') }}\"\n\n        proxmox_template_vm_slow_storage: true\n</code></pre>"},{"location":"roles/server_baseline/","title":"Server Baseline Role","text":"<p>This role makes a baseline configuration for linux servers. The following configurations are made:</p> <ul> <li>Create a user with sudo privileges*</li> <li>Copy your SSH key to the server and disable password-based authentication</li> <li>Update apt/dnf and ensure a list of default packages are present</li> <li>Install any additional desired system packages</li> <li>Configure default deny on the firewall, allowing SSH connections* </li> <li>Install and bring up Tailscale</li> </ul> <p>*Not executed on Proxmox hosts</p>"},{"location":"roles/server_baseline/#requirements","title":"Requirements","text":""},{"location":"roles/server_baseline/#supported-operating-systems","title":"Supported Operating Systems","text":"<p>As of the latest update, the only tested and supported operating systems are: - Ubuntu 22.04+ - Fedora 40+ - Proxmox 8+</p> <p>Other versions may work but have not been tested.</p>"},{"location":"roles/server_baseline/#tailscale-oauth-client-secret","title":"Tailscale OAuth Client Secret","text":"<p>You will need a Tailscale account and an OAuth client secret to use this role.</p>"},{"location":"roles/server_baseline/#role-variables","title":"Role Variables","text":""},{"location":"roles/server_baseline/#required-variables","title":"Required Variables","text":"<p>Not providing these variables will cause the task to fail.</p> <pre><code>server_baseline_created_username: &lt;your-username&gt;              # Username to create with sudo privileges\nserver_baseline_tailscale_oauth_client_secret: &lt;secret&gt;        # Tailscale OAuth client secret (dict format recommended)\nserver_baseline_timezone: &lt;server-timezone&gt;                    # Timezone to set on server\n</code></pre>"},{"location":"roles/server_baseline/#example-required-variables","title":"Example - Required Variables","text":"<pre><code>server_baseline_created_username: vcaldas\nserver_baseline_tailscale_oauth_client_secret: \"{{ tailscale_servers_oauth_client['key'] }}\"  # From Ansible vault\nserver_baseline_timezone: Europe/Amsterdam\n</code></pre>"},{"location":"roles/server_baseline/#optional-variables","title":"Optional Variables","text":"<p>Install additional packages beyond the defaults:</p> <pre><code>server_baseline_fedora_packages: []      # Additional packages for Fedora\nserver_baseline_ubuntu_packages: []      # Additional packages for Ubuntu\nserver_baseline_proxmox_packages: []     # Additional packages for Proxmox\n</code></pre>"},{"location":"roles/server_baseline/#example-optional-variables","title":"Example - Optional Variables","text":"<pre><code>server_baseline_fedora_packages:\n  - borgbackup\n  - tmux\n\nserver_baseline_ubuntu_packages:\n  - aptitude\n  - borgbackup\n  - tmux\n\nserver_baseline_proxmox_packages:\n  - tmux\n  - iperf3\n</code></pre>"},{"location":"roles/server_baseline/#default-packages-by-distribution","title":"Default Packages by Distribution","text":"<p>Ubuntu: - curl - nano - vim - git - ufw - cifs-utils</p> <p>Fedora: - curl - nano - vim - git - dnf-plugins-core - firewalld - cifs-utils</p> <p>Proxmox: - curl - nano - vim - git - python3-proxmoxer - python3-requests</p>"},{"location":"roles/server_baseline/#dependencies","title":"Dependencies","text":""},{"location":"roles/server_baseline/#artis3ntailscale-collection","title":"artis3n.tailscale Collection","text":"<p>This role depends on the artis3n.tailscale collection for Tailscale installation.</p> <p>Install with:</p> <pre><code>ansible-galaxy collection install artis3n.tailscale\n</code></pre>"},{"location":"roles/server_baseline/#example-playbook","title":"Example Playbook","text":"<pre><code>- name: Configure baseline servers\n  hosts: all\n\n  tasks:\n    - name: Run server baseline\n      ansible.builtin.include_role:\n        name: server_baseline\n      vars:\n        server_baseline_created_username: vcaldas\n        server_baseline_tailscale_oauth_client_secret: \"{{ tailscale_servers_oauth_client['key'] }}\"\n        server_baseline_timezone: Europe/Amsterdam\n        server_baseline_ubuntu_packages:\n          - tmux\n          - ncdu\n</code></pre>"}]}